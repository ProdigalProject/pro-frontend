<!DOCTYPE html>
<html lang="en">
<head>
        {% load static %}
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/3/w3.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
        <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}"/>
        <title>Prodigal - Search</title>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      function autocomplete(inp, arr) {
      var currentFocus;
      inp.addEventListener("input", function(e) {
      var a, b, i, val = this.value;
      closeAllLists();
      if (!val) { return false;}
      currentFocus = -1;
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      this.parentNode.appendChild(a);
      for (i = 0; i < arr.length; i++) {
        if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
          b = document.createElement("DIV");
          b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
          b.innerHTML += arr[i].substr(val.length);
          b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
              b.addEventListener("click", function(e) {
              inp.value = this.getElementsByTagName("input")[0].value;
              closeAllLists();
          });
          a.appendChild(b);
        }
      }
    });
    inp.addEventListener("keydown", function(e) {
      var x = document.getElementById(this.id + "autocomplete-list");
      if (x) x = x.getElementsByTagName("div");
      if (e.keyCode == 40) {
        currentFocus++;
        addActive(x);
      } else if (e.keyCode == 38) { //up
        currentFocus--;
        addActive(x);
      } else if (e.keyCode == 13) {
        e.preventDefault();
        if (currentFocus > -1) {
          if (x) x[currentFocus].click();
        }
      }
    });
    function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("autocomplete-active");
    }
    function removeActive(x) {
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
    }
    function closeAllLists(elmnt) {
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
      x[i].parentNode.removeChild(x[i]);
    }
    }
    }
    }       
    
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);
      function drawChart() {
        var decoded = ('{{ chart_json }} ').replace(/&#39;/g,'\"');

        var chart_json = JSON.parse( decoded );

        var data = new google.visualization.DataTable();
        data.addColumn('date', 'Date');
        data.addColumn('number', 'Closing price');

        var numRows = chart_json.length;

        for (var i = 0; i < numRows; i++){

            var a = chart_json[i].date
            var res = a.split("-");

            var d = new Date(res[0],res[1]-1,res[2]);

            var myrow = new Array(d, chart_json[i].closing);

            data.addRow(myrow);
        }

        var options = {
          chartArea:{width:"90%",height:"80%"},
          curveType: 'function',
          legend: { position: 'bottom' }
        };

        var chart = new google.visualization.LineChart(document.getElementById('stock_chart'));

        chart.draw(data, options);
      }
    </script>
    </head>
    <body>
        <!-- Navigation -->
        <div class="w3-top">
            <nav class="w3-bar w3-black w3-padding-16">
                <a href="/prodigal_app" id="navbar_logo" class="w3-bar-item"><img src="{% static "images/navbar_logo.png" %}" alt="prodigal_logo_horizontal"></a>
                  <div class = "autoComplete">
                   <form id="search" method="POST" name="search_form" action="search">
                   <input id="navbar_searchbox" type="search" name="search_key" placeholder="Search by ticker symbol...">
                   <button id="navbar_search_submit" type="submit" class="search-submit w3-button w3-blue w3-large"><i class="fa fa-search"></i></button>
                   </form>
                  </div>
                  <script>
                    var stocks = ["Apple", "Facebook", "Amazon", "JP Morgan", "Goldman Sachs", "Twitter", "Twilio", "Ford", "General Motors"];
                    //var stocks = NasdaqCompanies.objects();
                    var searchBox = document.getElementById("navbar_searchbox");
                    searchBox.autocomplete = 'off';
                    autocomplete(searchBox, stocks);
                   </script>
                <a href="profile" id="navbar_profile" class="w3-button w3-bar-item w3-large w3-right">Profile</a>
            </nav>
        </div>
        <!-- No matching search results -->
        {% if msg %}
        <div id="search-container" style="margin: 80px 2% 0 2%; min-height:100vh">
            <h1 id="fail"> {{ msg }} </h1>
        </div>
        <!-- Search Results -->
        {% else %}
        <div id="search-container" style="margin: 80px 2% 0 2%; min-height:100vh">
            <div id="result">
                <div id="search_top_container">
                    <div id="company_name" style="display: inline-block;">
                        <h1>{{ name }}</h1>
                    </div>
                    <iframe src="favorite" width="250px" height="74px" style="border:none; display:inline-block; vertical-align: middle; margin-left: 10px"></iframe>
                </div>
                <h2>Projection</h2>
                <div id="stock_chart" style="width: 728px; height: 450px; margin-bottom:20px">
                    <!-- Div for chart -->
                </div>
                {% if high %}
                <div id="company_basic_stock" style="display: inline-block;">
                    <h2>Latest Data</h2>
                    <table>
                        <tr>
                            <th>High:</th>
                            <td>{{ high }}</td>
                        </tr>
                        <tr>
                            <th>Low:</th>
                            <td>{{ low }}</td>
                        </tr>
                        <tr>
                            <th>Opening:</th>
                            <td>{{ opening }}</td>
                        </tr>
                        <tr>
                            <th>Closing:</th>
                            <td>{{ closing }}</td>
                        </tr>
                        <tr>
                            <th>Volume:</th>
                            <td>{{ volume }}</td>
                        </tr>
                    </table>
                    <br>
                </div>
                {% endif %}
                {% if desc %}
                <div id="company_description" style="margin: 10px 0">
                    <h2>Company Description</h2>
                    {% for p in desc %}
                        <p> {{ p }} </p>
                    {% endfor %}
                </div>
                {% endif %}
                <div id="news" style="margin: 10px 0">
                    <h2>News</h2>
                    <ul id="news_list">
                        {% for news, link in newslist %}
                            <li><a href={{ link }} target="_blank">{{ news }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- Footer -->
        <footer id="Home" class="w3-container w3-padding-64 w3-center w3-black w3-xlarge">
            <a href="#"><i class="fa fa-facebook-official"></i></a>
            <a href="#"><i class="fa fa-twitter"></i></a>
            <a href="#"><i class="fa fa-flickr"></i></a>
            <a href="#"><i class="fa fa-linkedin"></i></a>
            <p class="w3-medium">
                Powered by <a href="https://www.w3schools.com/w3css/default.asp" target="_blank">w3.css</a>
            </p>
        </footer>
    </body>
</html>